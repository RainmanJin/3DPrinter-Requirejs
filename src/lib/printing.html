<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>在线打印</title>
    <link type="image/x-icon" rel="shortcut icon" href="images/favicon.ico">

    <link rel="stylesheet" href="bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="Less/cloud_printer.css">
    <link rel="stylesheet" href="Less/upload.css">
</head>
<body onload="threeStart();" >
<div>
    <nav class="navbar navbar-default c_navbar navbar-static-top" role="navigation">
        <div class="container c_cot">
            <div class="navbar-header c_header">
                <button type="button" class="navbar-toggle " data-toggle="collapse" data-target="#navbar-menu">
                    <span class="sr-only">切换导航</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">
                    <img src="images/brand.png" alt="" class="img-responsive center-block brand_img hidden-xs">
                </a>
            </div>

            <div class="collapse navbar-collapse" id="navbar-menu">
                <ul class="nav navbar-nav navbar-right">
                    <li class="cative nav_menu_li"><a href="http://120.79.148.35:3010/#/home" class="nav_menu_font">首页</a></li>
                    <li class="cative nav_menu_li"><a href="http://120.79.148.35:3010/modelbase" class="nav_menu_font">模型库</a></li>
                    <li class="cative nav_menu_li"><a href="https://3d.biowinedu.com/authenticate" class="nav_menu_font">在线建模</a></li>
                    <li class="cative nav_menu_li"><a href="http://120.79.148.35:3010/printing" class="nav_menu_font">在线打印</a></li>
                    <li class="cative nav_menu_li"><a href="http://120.79.148.35:3010/shequ" class="nav_menu_font">社区</a></li>
                    <li class="cative nav_menu_li"><a href="http://120.79.148.35:3010/about" class="nav_menu_font">关于</a></li>
                    <li class="cative nav_menu_li btn_login login_img">
                        <a href="http://120.79.148.35:3010/#/login">
                            <img src="images/login.png" class="img-circle">
                            <span>user_test</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>


<div class="container-fluid" id="prev">
    <div class="row">
        <div class="col-md-7 prev_left clearfix">
            <div id="canvas3d"></div>
            <div class="file-box">
                <form id="uploadForm">
                    <input type="file" name="file" class="file" id="fileField"  />
                </form>
            </div>
        </div>
        <div class="col-md-5 prev_right">
            <ul>

                <li>
                    <img src="images/cloud.png" alt="" class="img-responsive">
                    <span>打印机类型:</span>&nbsp;
                    <span>Printors i3</span>
                </li>
                <li>
                    <img src="images/locate.png" alt="" class="img-responsive">
                    <span>打印机地点:</span>&nbsp;
                    <span>昆明理工大学呈贡校区综合性体育运动馆</span>
                </li>
                <li>
                    <img src="images/file.png" alt="" class="img-responsive file_png">
                    <span>文件名:</span>&nbsp;
                    <span class="fileName">xxx.stl</span>
                </li>
                <li>
                    <img src="images/resize-full-alt.png" alt="" class="img-responsive resize_png">
                    <span>尺寸大小:</span>&nbsp;
                    <span class="x_size">0mm x </span>
                    <span class="y_size">0mm x </span>
                    <span class="z_size">0mm</span>
                </li>
                <li>
                    <img src="images/pla.png" alt="" class="img-responsive pla_png">
                    <span>耗材:</span>&nbsp;
                    <div class="select">
                        <select>
                            <option>PLA</option>
                        </select>
                    </div>
                    <span class="price"> *0.8元/g</span>
                </li>
                <li>
                    <img src="images/size.png" alt="" class="img-responsive size_png">
                    <span>模型比例:</span>&nbsp;
                    <div class="pro_bar">
                        <div class="progress">
                            <div class="progress-bar"></div>
                        </div>
                        <a class="pro_control" href="javascript:;" ></a>
                        <div id="progress_value">0%</div>
                    </div>
                </li>
                <li>
                    <img src="images/type.png" alt="" class="img-responsive type_png">
                    <span>打印模式:</span>&nbsp;
                    <div class="pri_type">
                        <div class="btn-group " role="group" aria-label="...">
                            <button type="button" class="btn btn-default">快速</button>
                            <button type="button" class="btn btn-default">标准</button>
                            <button type="button" class="btn btn-default">品质</button>
                            <button type="button" class="btn btn-default">自定义</button>
                        </div>
                    </div>
                </li>
                <li>
                    <img src="images/number.png" alt="" class="img-responsive number_png">
                    <span>数量:</span>&nbsp;
                    <div class="btn-group number" role="group" aria-label="...">
                        <span class="down">-</span><span class="num">1</span><span class="add">+</span>
                    </div>
                </li>
                <li>
                    <img src="images/time.png" alt="" class="img-responsive time_png">
                    <span>预估时间:</span>&nbsp;
                    <span class="time">2 h 30 min</span>
                </li>
                <li>
                    <img src="images/price.png" alt="" class="img-responsive price_png">
                    <span>总价:</span>&nbsp;
                    <span class="money">￥0</span>
                </li>
                <li class="text-center operation">
                    <button class="btn btn-success btn-sm op_btn op_btn1">上传文件</button>
                    <button class="btn btn-success btn-sm op_btn op_btn2">加入队列</button>
                    <button class="btn btn-success btn-sm op_btn op_btn3">立即打印</button>
                </li>
            </ul>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="panel panel-default">
            <div class="panel-heading">购物车</div>
            <div class="panel-body shopping">
               <table class="table text-center tb_queue">
                   <tr class="main">
                       <td>订单文件名</td>
                       <td>订单编号</td>
                       <td>模型信息</td>
                       <td>模型数量</td>
                       <td>金额</td>
                       <td>管理</td>
                   </tr>
               </table>
                <div class="text-right">
                    <span class="sumMoney ">￥ 0</span>
                    <a class="sumAll" href="apply.html">合计</a>
                </div>
            </div>
    </div>
</div>



<div class="clearfix">
    <div class="container-fluid footer">
      <div class="row">
        <div class="col-lg-2 col-lg-offset-5">
          <h3 class="h_word">联系我们</h3>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-4 col-lg-offset-4 col-md-4 col-md-offset-4 text-center">
          <img src="images/wechat.png" alt="" class="img-responsive center-block f_img">
          <img src="images/qq.png" alt="" class="img-responsive center-block f_img">
          <img src="images/weibo.png" alt="" class="img-responsive center-block f_img">
          <img src="images/facebook.png" alt="" class="img-responsive center-block f_img">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3">
          <h3>地址：广东省广州大学城广东工业大学E110</h3>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 col-lg-offset-3 col-md-6 col-md-offset-3">
          <h3>@2017-2018 Printors.Allright reserved.</h3>
        </div>
      </div>
    </div>

</div>
</div>





<script src="Jquery/jquery-1.12.4.js"></script>
<script src="bootstrap/bootstrap.min.js"></script>
<script src="threejs/three.js"></script>
<script src="threejs/loaders/STLLoader.js"></script>
<script src="threejs/OrbitControls.js"></script>


<script>



/**********************j监听窗口变化解决画布不响应的问题*************************/

        //监听窗口变化，重新加载页面
        var timer=null;
        window.onresize=function () {
            clearInterval(timer);

            //进行节流

            timer=setTimeout(function () {
                location.reload()
            },200);
        };


/************************js进度条***************************/


        var  module_x;
        var  module_y;
        var  module_z;


        //得到进度条的所需元素
        var pro_bar=document.getElementsByClassName("pro_bar");
        var progress=document.getElementsByClassName("progress")[0];
        var progress_bar=document.getElementsByClassName("progress-bar")[0];
        var mask=document.getElementsByClassName("pro_control")[0];
        var progress_value=document.getElementById("progress_value");


        //鼠标按下出发事件对象
        mask.onmousedown = function (event) {
            var e = event || window.event;


            // 2.1 获取初始位置
            var offsetLeft = e.clientX - mask.offsetLeft;

            // 2.2 监听鼠标的移动
            document.onmousemove = function (event) {
                var e = event || window.event;

                // 2.3 获取移动的位置
                var x = e.clientX - offsetLeft;

                // 边界值处理
                if (x < 0) {
                    x = 0;
                } else if (x >= progress.offsetWidth - mask.offsetWidth) {
                    x = progress.offsetWidth - mask.offsetWidth;
                }

                // 2.4 走起来

                progress_bar.style.width = x + 'px';
                mask.style.left = x + 'px';
                var proMove=parseInt(x / (progress.offsetWidth - mask.offsetWidth)*100);
                progress_value.innerHTML = proMove+ '%';


                x_size.innerHTML=Math.abs(module_x*proMove/100) +"mm x";
                y_size.innerHTML=Math.abs(module_y*proMove/100) +"mm x";
                z_size.innerHTML=Math.abs(module_z*proMove/100) +"mm";
                total=Math.abs(module_x*module_y*module_z*proMove/100);
                Money=Math.ceil(total*0.00008);
                document.getElementsByClassName("money")[0].innerHTML="￥"+Money*Number;
                MONEY="￥"+Money*Number;

                return false;
                }
            };


            // 2.5 监听鼠标抬起
        document.onmouseup = function () {
            document.onmousemove = null;
        };


/************************jq打印模式的选择*******************************/


        var btn_list=$(".pri_type button");
        for(var i=0;i<btn_list.length;i++){
            (function (i) {
                $(btn_list[i]).click(function () {
                    $(btn_list[i]).addClass("selected")
                        .siblings().removeClass("selected");
                });
            })(i);
        }



/************************jq文件上传、队列、下单*******************************/

        var btnList=$(".operation button");

        btnList.eq(0).click(function () {
            //js对象->jq对象
            $(INPUT).click();
        });


/************************jq结算跳转*******************************/

        $(".sumAll").click(function () {
            // alert("ok")
        });







/**********************three.js的代码区*********************************/


        //预览图的元素
        var divCanvas=document.getElementById("canvas3d");

        //预览图的宽高
        var Width=document.getElementById("canvas3d").clientWidth;
        var Height=document.getElementById("canvas3d").clientHeight;

        //待定参数
        var Input=document.getElementById("input");
        var btn=document.getElementById("btn");



        //sessionStorage变量->文件名
        var Storage=sessionStorage.getItem("data");

        var filename=sessionStorage.getItem("fileName");



        //全局变量->文件名(读取文件用)
        var fileName;
        //全局变量->文件名(读取文件名)
        var f_name;



        //判断是否有本地缓存（5M以下）
        if (isNaN(Storage)){
            fileName=Storage;

            f_name=filename;


            //删除缓存
            sessionStorage.setItem("data",null);
            sessionStorage.setItem("filename",null);

        }




        //读取文件信息的函数
        function readURL(input) {

            if (input.files && input.files[0]) {

                var reader = new FileReader();

                reader.onload = function(e) {
                    //得到文件名(base64编码)
                    fileName=e.target.result;
                    divCanvas.removeChild( renderer.domElement );

                    threeStart();

                };
                reader.readAsDataURL(input.files[0]);
            }



        }
        //模型大小的显示span
        var x_size=document.getElementsByClassName("x_size")[0];
        var y_size=document.getElementsByClassName("y_size")[0];

        var z_size=document.getElementsByClassName("z_size")[0];
        //上传预览按钮
        var INPUT=document.getElementById("fileField");

        var file_name=document.getElementsByClassName("fileName")[0];


        //购物车业务
        var test;
        var SIZE;
        var total;
        var Number=1;
        var MONEY;
        var dowm=$(".down");
        var add=$(".add");

        dowm.click(function () {
            if(Number==1){
                Number=1
            }else {
                Number-=1;
                document.getElementsByClassName("num")[0].innerHTML=Number;
                document.getElementsByClassName("money")[0].innerHTML="￥"+Money*Number;
                MONEY="￥"+Money*Number;
            }
        });
        add.click(function () {
                Number+=1;
                document.getElementsByClassName("num")[0].innerHTML=Number;
                document.getElementsByClassName("money")[0].innerHTML="￥"+Money*Number;
                MONEY="￥"+Money*Number;

        });



        //文件名处理
        if(!fileName){
            fileName='static/module/bike_frame.stl'
        }else {

        }


        INPUT.onchange=function(){

            //获取文件路径
            var path=INPUT.value;

            // 截取文件名后缀
            var file=path.substr(path.lastIndexOf("."));
            test=this.files[0].name;
            SIZE=this.files[0].size;
            file_name.innerHTML=this.files[0].name || f_name;


            if (file!==".stl"){
                INPUT.value="";
                return;
            }else {
                readURL(INPUT);
            }
        };



        //相机的相应参数
        var container;

        var camera, cameraTarget, scene, renderer,helper;

        var perspectiveAngle = 45;
        var cameraPosX = 900;
        var cameraPosY = 1200;
        var cameraPosZ = 2400;
        var cameraTargetX = -100;
        var cameraTargetY = -500;
        var cameraTargetZ = 800;
        var upVectorX = 0;
        var upVectorY = 50;
        var upVectorZ = 0;
        var cameralScale =0.5;

        var Money=0;



        //模型大小比例1:1
        var model_x=model_y=model_z=1;

        function init() {

            camera = new THREE.PerspectiveCamera( perspectiveAngle, 1, 1, 10000 );

            camera.position.set( cameraPosX, cameraPosY, cameraPosZ);
            camera.up.set(upVectorX, upVectorY, upVectorZ);

            cameraTarget = new THREE.Vector3( cameraTargetX, cameraTargetY, cameraTargetZ );
            camera.lookAt( cameraTarget );

            scene = new THREE.Scene();
            scene.fog = new THREE.Fog( 0xffffff, 0, 9000 );




            // 实例stlloader

            var loader = new THREE.STLLoader();
            loader.load(fileName, function ( geometry ) {
                //材料颜色
                var material = new THREE.MeshPhongMaterial( { color: 0x008080, specular: 0xC0C0C0, shininess: 200 } );
                var mesh = new THREE.Mesh( geometry, material );
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.scale.set(model_x,model_y,model_z);
                // mesh.rotation.x = -0.5 * Math.PI;
                scene.add(mesh);



                //计算模型尺寸
                geometry.computeBoundingBox();
                var boundbox=geometry.boundingBox;
                //模型尺寸
                 module_x=(boundbox.max.x-boundbox.min.x).toFixed(0);
                 module_y=(boundbox.max.x-boundbox.min.y).toFixed(0);
                 module_z=(boundbox.max.x-boundbox.min.z).toFixed(0);

                if (module_x==-Infinity){
                    return;
                } else {
                    x_size.innerHTML=Math.abs(module_x) +"mm x";
                    y_size.innerHTML=Math.abs(module_y) +"mm x";
                    z_size.innerHTML=Math.abs(module_z) +"mm";
                    total=Math.abs(module_x*module_y*module_z);
                    Money=Math.ceil(total*0.00008);
                    document.getElementsByClassName("money")[0].innerHTML="￥"+Money*Number;
                    MONEY="￥"+Money*Number;

                }

                //对模型位置进行判断

                if (boundbox.min.y>=0) {
                    mesh.position.set(0,-boundbox.min.y-600,0);
                }else {
                    mesh.position.set(0,-boundbox.min.y-600,0);
                }
                scene.add(camera);

            } );



            // 增加lights

            scene.add( new THREE.AmbientLight( 0x333333 ) );

            addDirectionalLight(-1, 1, 1, 0xFFFFFF, 1.0);
            addDirectionalLight(1, -1, -1, 0xFFFFFF, 1);

            //网格
            var  helper = new THREE.GridHelper( 500, 50 );

            helper.setColors( scene.fog);

            helper.position.set(0,-600,0);
            scene.add( helper );


            //x,y,z轴
            var axisHelper = new THREE.AxisHelper(1000);
            axisHelper.position.set(-500,-600,-500);

            scene.add(axisHelper);


            var axisHelper2 = new THREE.AxisHelper(1000);
            axisHelper2.position.set(500,-600,-500);
            axisHelper2.rotation.y=-70.6855;
            scene.add(axisHelper2);


            var axisHelper3 = new THREE.AxisHelper(1000);
            axisHelper3.position.set(-500,-600,500);
            axisHelper3.rotation.y=70.6855;
            scene.add(axisHelper3);


            var axisHelper4 = new THREE.AxisHelper(1000);
            axisHelper4.position.set(500,-600,500);
            axisHelper4.rotation.y=141.371;
            scene.add(axisHelper4);




            var axisHelper5 = new THREE.AxisHelper(1000);
            axisHelper5.position.set(-500,800,-500);
            axisHelper5.rotation.z=-70.6855;
            scene.add(axisHelper5);


            var axisHelper6 = new THREE.AxisHelper(1000);
            axisHelper6.position.set(500,800,-500);
            axisHelper6.rotation.y=-70.6855;
            axisHelper6.rotation.z=-70.6855;
            scene.add(axisHelper6);


            var axisHelper7 = new THREE.AxisHelper(1000);
            axisHelper7.position.set(500,800,500);
            axisHelper7.rotation.y=-141.371;
            axisHelper7.rotation.z=-70.6855;
            scene.add(axisHelper7);


            var axisHelper8 = new THREE.AxisHelper(1000);
            axisHelper8.position.set(-500,800,500);
            axisHelper8.rotation.y=70.6855;
            axisHelper8.rotation.z=-70.6855;
            scene.add(axisHelper8);




            // renderer渲染
            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setClearColor( 0xfafafa );
            renderer.setSize( Width, Height );

            renderer.gammaInput = true;
            renderer.gammaOutput = true;

            renderer.shadowMapEnabled = true;
            renderer.shadowMapCullFace = THREE.CullFaceBack;

            divCanvas.appendChild( renderer.domElement );



            // orbit control鼠标控制

            control = new THREE.OrbitControls( camera, renderer.domElement );
            control.enablePan = true;



        }


        function addDirectionalLight( x, y, z, color, intensity ) {

            var directionalLight = new THREE.DirectionalLight( color, intensity );
            directionalLight.position.set( x, y, z )
            scene.add( directionalLight );
        }


        function animate() {

            requestAnimationFrame( animate );

            render();

        }

        function render() {

            renderer.render( scene, camera );
        }


        function threeStart(){
            init();
            animate();
        }





//得到确定上传文件的按钮
        var $sumMoney=$(".sumMoney");
        var btn=$(".op_btn2");

        var arr=[];
        var queue=[];
        var num=0;
        //测试是否得到输入框的文件
        btn.click(function () {

            fi=test;

            //缓存文件在数组
            arr.push(fi);

            //文件的大小
            file_size=SIZE;


            var $queue = createQueue(arr[num]);
                 $(".tb_queue").append($queue);
                 num+=1;

            numMoney.push(Money*Number);

            allMoney+=Money*Number;
            $sumMoney.text("￥"+ allMoney);
            Number=1;
            document.getElementsByClassName("num")[0].innerHTML=Number;


        });


        function createQueue(arr) {
            var $queue = $(" <tr><td>"+arr+
  "</td><td>"+new Date().getTime()+"</td><td>"+total+" mm³</td><td>"+Number+"</td><td>"+MONEY+"</td><td>\n"+
                "<button class=\"btn btn-danger dancel\">取消</button>\n"+
                "</td>\n"+
                "</tr>");
            // queue.push(obj);
            return $queue;
        }

        var allMoney=0;
        var numMoney=[];


        $("body").delegate(".sum", "click", function () {
            console.log($(this).index());;
        });

        $("body").delegate(".dancel", "click", function () {
            allMoney-=numMoney[$(this).parents("tr").index()-1];
            var arr=numMoney[$(this).parents("tr").index()-1];


            numMoney.splice($.inArray(arr,numMoney),1);

            $sumMoney.text("￥"+ allMoney);

            if(String(allMoney)=="NaN"){
                $sumMoney.text("￥ 0");
            }
            $(this).parents("tr").remove();

        });




</script>
</body>
</html>